<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Alfalfa: A Videoconferencing Protocol for Cellular Wireless Networks
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content=Alfalfa is an Internet
videoconferencing protocol that works well over cellular wireless
networks, where link speeds change dramatically with time, and current
transport protocols build up lengthy in-network queues.">
    <meta name="author" content="Keith Winstein <keithw@mit.edu>">

    <!-- Le styles -->
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .callout {
      }
      .hero-titles {
        padding-bottom: 5%;
      }
      .logo {
        padding: 8px;
      }
      .prelike {
      display: block;
      padding: 8.5px;
      margin: 0 0 9px;
      font-size: 12.025px;
      line-height: 18px;
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      border: 1px solid rgba(0, 0, 0, 0.15);
      -webkit-border-radius: 4px;
      -moz-border-radius: 4px;
      border-radius: 4px;
      word-break: break-all;
      word-wrap: break-word;
      }
      tr.os td {
      vertical-align: bottom;
      }
      tr.inst td {
      vertical-align: top;
      }
    </style>
    <link href="assets/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-30270105-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>

  </head>

  <body data-spy="scroll">

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Mosh</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li><a href="#about">About</a></li>
              <li><a href="#sprout">Sprout</a></li>
              <li><a href="#results">Results</a></li>
              <li><a href="#methods">Methods</a></li>
              <li><a href="#video">State-sync video</a></li>
              <li><a href="#code">Code</a></li>
              <li><a href="#faq">FAQ</a></li>
              <li><a href="#contact">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

      <section id="about">
      <div class="hero-unit">
	<p>
	<div class="row">
	<div class="span5">
        <p><h1>Alfalfa</h1>

	<p>Alfalfa is an Internet videoconferencing protocol that
works well over cellular wireless networks, where link speeds change
dramatically with time, and current applications build up
lengthy in-network queues.</p>

	<p>In evaluations on traces from commercial LTE and 3G
	  networks, Alfalfa's rate control scheme achieved 2&ndash;4
	  times the throughput of Skype, Apple Facetime, and Google
	  Hangout, while reducing self-inflicted delay by 7&ndash;9
	  times.</p>

	<p>Our draft research paper (under submission), the C++ implementation,
	  and supplementary information are available here. We welcome
	  contributions to the code and your feedback!</p>

	</div><div class="span5"><img src="mosh.png" style="max-width:120%;"></div>
	</div>
	</p>

        <p><a class="btn btn-primary btn-large" href="#getting">Getting Mosh &raquo;</a>
        <a class="btn btn-primary btn-large" href="#techinfo">Tech Video &raquo;</a></p>
      </div>

      <div class="row">

        <div class="span4">
          <h2 class="callout">Change IP. Stay connected.</h2>
          <p>Mosh automatically roams as you move between Internet
          connections. Use Wi-Fi on the train, Ethernet in a hotel,
          and LTE on a beach: you'll stay logged in. Most network
          programs lose their connections after roaming,
          including SSH and Web apps like Gmail. Mosh
          is different.</p>
        </div>
        <div class="span4">
          <h2 class="callout">Makes for sweet dreams.</h2>
           <p>With Mosh, you can put your laptop to sleep and wake it
	     up later, keeping your connection intact. If your
	     Internet connection drops, Mosh will warn you &mdash; but
	     the connection resumes when network service
	     comes back.
       </div>
        <div class="span4">
          <h2 class="callout">Get rid of network lag.</h2>
          <p>SSH waits for the server's reply before showing you your
	    own typing. That can make for a lousy user interface. Mosh
	    is different: it gives an instant response to typing,
	    deleting, and line editing. It does this adaptively and
	    works even in full-screen programs like emacs and vim. On
	    a bad connection, outstanding predictions are underlined
	    so you won't be misled.
	  </p>
        </div>
      </div>

      <div class="row">
        <div class="span3">
          <h2 class="callout">No privileged code. No daemon.</h2>
           <p>You don't need to be the superuser to install or run
	     Mosh. The client and server are executables run by an
	     ordinary user and last only for the life of the
	     connection.</p>
        </div>

        <div class="span3">
          <h2 class="callout">Same login method.</h2>
           <p>Mosh doesn't listen on network ports or authenticate
	     users. The <tt>mosh</tt> client logs in to the server via
	     SSH, and users present the same credentials (e.g.,
	     password, public key) as before. Then Mosh runs the
	     <tt>mosh-server</tt> remotely and connects to it over UDP.</p>
        </div>

	<div class="span3">
	  <h2 class="callout">Runs inside your terminal, but better.</h2>
	  <p>Mosh is a command-line program, like ssh. You can use it
	  inside xterm, gnome-terminal, urxvt, Terminal.app, iTerm,
	  emacs, screen, or tmux. But mosh was designed from scratch
	  and supports just one character set: UTF-8. It fixes Unicode
	  bugs in other terminals and in SSH.
	</div>

	<div class="span3">
	  <h2 class="callout">Control-C works great.</h2>

	  <p>Unlike SSH, mosh's UDP-based protocol handles packet loss
	    gracefully, and sets the frame rate based on network conditions. Mosh
	    doesn't fill up network buffers, so Control-C always works
	    to halt a runaway process.</p>
	</div>
      </div>
      </section>
      
      <section id="getting">
	<div class="page-header">
	  <h1>Getting Mosh</h1>
	</div>

	<div class="row">
	  <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.debian.org"><img class="logo" src="debian.png"></a>Debian <small>squeeze-backports and later</small><br /></h3>
            <p><pre>$ sudo apt-get install mosh</pre></p>
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.fedoraproject.org"><img class="logo" src="fedora.png"></a>Fedora <small>15 or later</small></h3>
            <p><pre>$ sudo yum install mosh</pre></p>
	  </div>

          <div class="span4" sytle="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.ubuntu.com"><img class="logo" src="ubuntu.png"></a>Ubuntu <small>10.04 and later</small></h3>
            <p><pre>$ sudo apt-get install python-software-properties
$ sudo add-apt-repository ppa:keithw/mosh
$ sudo apt-get update
$ sudo apt-get install mosh</pre></p>
<p><small>Ubuntu also includes older versions of mosh in the universe repository (12.04 and later) and backports repository (10.04&ndash;11.10).</small></p>
            <br />
	  </div>
	</div>

	<div class="row">
          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.gentoo.org"><img class="logo" src="gentoo.png"></a> Gentoo</h3>
            <p><pre># emerge net-misc/mosh</pre></p>
	    <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.archlinux.org"><img class="logo" src="arch.png"></a> Arch Linux</h3>
            <p><pre># pacman -S mosh</pre></p>
            <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.freebsd.org"><img class="logo" src="freebsd.png"></a> FreeBSD</h3>
            <p><pre># portmaster net/mosh</pre></p>
            <br />
	  </div>
	</div>

	<div class="row">
          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.netbsd.org"><img class="logo" src="NetBSD-smaller-tb.png" width="50" height="50"></a>NetBSD <small>(pkgsrc)</small></h3>
	    <p><pre># cd net/mosh; make install clean</pre></p>
            <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.android.com/"><img class="logo" src="Android_Robot_100.png" width="50" height="50"></a>Android <small>(experimental port)</small></h3>
	    <p><div class="prelike">Install the <a href="http://dan.drown.org/android/mosh/">port by Daniel Drown</a>, built on Irssi ConnectBot.</div></p>
            <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.cygwin.com"><img class="logo" src="Cygwin_logo.svg" width="50" height="50"></a>Cygwin <small>(experimental port)</small></h3>
	    <p><div class="prelike">Install the <a href="http://cygwin.com/setup.exe">experimental package</a> from the Cygwin setup.exe.</div></p>
            <br />
	  </div>
	</div>

	<div class="row">
          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.apple.com"><img class="logo" src="macosx.png"></a>OS X <small>10.6 or later</small></h3>
            <p><div class="prelike">Install <a href="https://github.com/downloads/keithw/mosh/mosh-1.2.1.pkg"><img src="dmg.png"> mosh-1.2.1.pkg</a>.</div></p>
            <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://mxcl.github.com/homebrew/">Homebrew </a> <small>OS X 10.5 or later</small></h3>
            <p><pre>$ brew install mobile-shell</pre></p>
            <br />
	  </div>

          <div class="span4" style="vertical-align: top;">
	    <h3 class="callout"><a href="http://www.macports.org"><img class="logo" src="macports.png"></a>MacPorts <small>OS X 10.5 or later</small></h3>
            <p><pre>$ sudo port install mosh</pre></p>
            <br />
	  </div>
	</div>

	<p><small>Operating system logos are trademarks or registered trademarks and are displayed for identification
only. The vendors shown aren't affiliated with and haven't endorsed Mosh.</small></p>

	<p><h2>Building from source</h2></p>

        <div class="row">

	  <div class="span4">
	    <h3 class="callout">Dependencies</h3><br>
	    <table class="table table-striped" style="width: 100%;">
              <thead><tr><th>Name</th><th>Typical package</th></tr></thead>
              <tr class="deps"><td><a href="http://code.google.com/p/protobuf/">Protocol Buffers</a></td><td>protobuf-compiler, libprotobuf-dev</td></tr>
              <tr><td>ncurses</td><td>libncurses5-dev</td></tr>
              <tr><td>zlib</td><td>zlib1g-dev</td></tr>
              <tr><td>utempter (optional)</td><td>libutempter-dev</td></tr>
	      <tr><td>IO::Pty Perl module</td><td>libio-pty-perl</td></tr>
	      <tr><td>OpenSSL</td><td>libssl-dev</td></tr>
	    </table>
	  </div>

	  <div class="span3">
	    <h3 class="callout">Latest release</h3><br>
	    <p>Extract
              <a href="https://github.com/downloads/keithw/mosh/mosh-1.2.3.tar.gz">mosh-1.2.3.tar.gz</a>,
              then</p>
<pre>$ cd mosh-1.2.3
$ ./configure
$ make
# make install</pre>
	  </div>

	  <div class="span5">
	    <h3 class="callout">Compiling from Git</h3><br>
	    <p><pre>$ git clone <a href="https://github.com/keithw/mosh">https://github.com/keithw/mosh</a>
$ cd mosh
$ ./autogen.sh
$ ./configure
$ make
# make install</pre></p>
	  </div>
          <div class="span3">
            <h3 class=="callout">Security on new operating systems</h3></br>
            <p>
              Note that <code>mosh-client</code> receives an AES session key as an environment
              variable.  If you are porting Mosh to a new operating system, please make sure that a
              running process's environment variables are not readable by other users.  We have
              confirmed that this is the case on GNU/Linux, OS X, and FreeBSD.
            </p>
          </div>
	</div>
      </section>

      <section id="usage">
	<div class="page-header">
	  <h1>Usage</h1>
	</div>

	<p><h3 class="callout">Replaces interactive SSH. Instant keystroke response, robust to roaming. <small>But you'll need working UDP.</small></h3></p>

	<div class="row">
	  <div class="well span3 offset2">
	    <h2 class="callout" style="color: darkblue;">Typical usage</h2>
	    <p><pre>$ mosh <i>chewbacca.norad.mil</i></pre></p>
	    <p>Mosh will log the user in via SSH, then start a connection on a UDP port between 60000 and 61000.</p>
	  </div>

	  <div class="span4">
	    <h3 class="callout">Different username</h3>
	    <p><pre>$ mosh <b>potus@</b><i>ackbar.bls.gov</i></pre></p>
	  </div>

	  <div class="span4">
	    <h3 class="callout">Server binary outside path</h3>
	    <p><pre>$ mosh <b>--server=/tmp/mosh-server</b> <i>r2d2</i></pre></p>
	    <p>The user can specify an alternate path for the <code>mosh-server</code> on the remote host. The server binary can even
	      be installed in the user's home directory.</p>
	  </div>
	</div>

	<p></p>

	<div class="row">

	  <div class="span4">
	    <h3 class="callout">Selecting Mosh UDP port</h3>
	    <p><pre>$ mosh <b>-p 1234</b> <i>darth</i></pre></p>
	    <p>Useful when the server is behind a port-forwarder or NAT.</p>
	  </div>

          <div class="span4">
            <h3 class="callout">Selecting SSH port</h3>
            <p><pre>$ mosh <b>--ssh="ssh -p 2222"</b> <i>figrindan</i></pre></p>
          </div>

          <div class="span4">
            <h3 class="callout">Other SSH options</h3>
            <p><pre>$ mosh <b>--ssh="~/bin/ssh -i ./identity"</b> <i>fett</i></pre></p>
          </div>

        </div>

	<div class="row">

	  <div class="span4">
	    <h3 class="callout">Disable instant echo</h3>
	    <p><pre>$ mosh <b>--predict=never</b> <i>niennunb</i></pre></p>
	    <p>The <code>-n</code> switch is a synonym. By contrast,
	    passing <code style="white-space: nowrap;">--predict=always</code> or <code>-a</code>
	    will enable instant local echo even on low-delay
	    links.</p>
	  </div>

	  <div class="span4">
	    <h3 class="callout">With a command</h3>
	    <p><pre>$ mosh <i>pello</i> <b>-- screen -dr</b></pre></p>
	    <p>This reattaches to a long-running screen session.</p>
	  </div>
	</div>

	<h3 class="callout">Ending the connection</h3>

	<p>Normally, <tt>logout</tt> or <tt>exit</tt> on the remote host will close
	  the session. Mosh accepts the escape sequence <code>Ctrl-^
	  .</code>  (typically typed with Control-Shift-6, then a
	  period) to end the connection forcibly. To send a
	  literal Ctrl-^, type <code>Ctrl-^ ^</code>.</p>

	<h3 class="callout">Not yet supported, but on the roadmap</h3>

	<p>
	<ul>
	  <li>Forwarding of <a href="https://github.com/keithw/mosh/issues/41">X11</a>, <a href="https://github.com/keithw/mosh/issues/120">SSH agent</a>, etc.</li>

	  <li><a href="https://github.com/keithw/mosh/issues/81">IPv6</a>, with roaming between v4 and v6</li>

	  <li><a href="https://github.com/keithw/mosh/issues/32">Android client</a></li>
	</ul>
	</p>

	<h3 class="callout">Manual</h3>

	<p>More details can be found in
	the <code>mosh(1)</code>, <code>mosh-client(1)</code>,
	and <code>mosh-server(1)</code> manual pages.</p>

      </section>

      <section id="techinfo">
	<div class="page-header">
	  <h1>Technical Info</h1>
	</div>
	

	<h3 class="callout">Mosh at USENIX ATC</h3>

	<p>The <a href="mosh-paper.pdf"><img style="padding: 3px;"
	    src="pdf.png"> Mosh research paper</a> describes the
	    design and evaluation of Mosh in more detail than you may
	    want. The paper was presented at the
	  <a href="https://www.usenix.org/conference/atc12/tech-schedule/usenix-atc-12-technical-sessions">2012 USENIX
	    Annual Technical Conference</a>, held June 13&ndash;15, 2012, in
	    sunny Boston, Mass.</p>

<div align="center"><iframe width="560" height="315" src="http://www.youtube.com/embed/XsIxNYl0oyU?rel=0" frameborder="0" allowfullscreen></iframe></div>

<p></p>

	<div class="well"><h4 class="callout">&#8220;ISO 2022 locking escape
sequences oh flying spaghetti monster please kill me
now.&#8221; <small>&mdash; actual USENIX peer review on reading the
	      Mosh paper.</small>
	  </h4>

	  <p></p>

	  <p>(Why you should trust Mosh with your remote terminal needs: we
    worry about details so obscure, even USENIX reviewers don't want to
	      hear about them.)</p>

	</div>

	<h3 class="callout">How Mosh works</h3>

	<p>Remote-shell protocols traditionally work by conveying a
	  byte-stream from the server to the client, to be interpreted
	  by the client's terminal. (This includes TELNET, RLOGIN, and
	  SSH.)</p>

	  <p>Mosh works differently and at a different layer. With
	    Mosh, the server and client both maintain a snapshot of
	    the current screen state. The problem becomes one of
	    <i>state-synchronization</i>: getting the client to the
	    most recent server-side screen as efficiently as
	    possible.</p>

	  <p>This is accomplished using a new protocol called the
	    State Synchronization Protocol, for which Mosh is the
	    first application. SSP runs over UDP, synchronizing the
	    state of any object from one host to another. Datagrams
	    are encrypted and authenticated
	    using <a href="http://www.cs.ucdavis.edu/~rogaway/ocb/">AES-128
	    in OCB mode</a>. While SSP takes care of the networking
	    protocol, it is the implementation of the object being
	    synchronized that defines the ultimate semantics of the
	    protocol.</p>

	  <p>Roaming with SSP becomes easy: the client sends datagrams
	    to the server with increasing sequence numbers, including
	    a heartbeat at least once every three seconds. Every time
	    the server receives an authentic packet from the client
	    with a sequence number higher than any it has previously
	    received, the IP source address of that packet becomes the
	    server's new target for its outgoing packets. By doing
	    roaming “statelessly” in this manner, roaming works in and
	    out of NATs, even ones that may themselves be
	    roaming. Roaming works even when the client is not aware
	    that its Internet-visible IP address has changed. The
	    heartbeats allow Mosh to inform the user when it hasn't
	    heard from the server in a while (unlike SSH, where users
	    may be unaware of a dropped connection until they try to
	    type).</p>

	  <p>Mosh runs two copies of SSP, one in each direction of the
	    connection. The connection from client to server
	    synchronizes an object that represents the keys typed by
	    the user, and with TCP-like semantics. The connection from
	    server to client synchronizes an object that represent the
	    current screen state, and the goal is always to convey the
	    client to the most recent server-side state, possibly
	  skipping intermediate frames.</p>

	  <p>Because SSP works at the object layer and can control the
	    rate of synchronization (in other words, the frame rate),
	    it does not need to send every byte it receives from the
	    application. That means Mosh can regulate the frames so as
	    not to fill up network buffers, retaining the
	    responsiveness of the connection and making sure Control-C
	    always works quickly. Protocols that must send every byte
	    can't do this.</p>

	<h3 class="callout">Careful terminal emulation</h3>

	  <p>One benefit of working at the terminal layer
	    was the opportunity to build a clean UTF-8 terminal
	    emulator from scratch. Mosh fixes several Unicode bugs in
	    existing terminals and in SSH, and was designed as a fresh
	    start to try to be robust and correct even for
	    pathological inputs.</p>

	<h4 class="callout">Tricky Unicode</h4>

	<p>Only Mosh and the OS X Terminal correctly handle a Unicode combining character in the first column.</p>

	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/firstcol-xterm.png.2.png"><br>xterm: circumflex on wrong letter.</div>
	    <div class="span5 well"><img src="terminal-shots/firstcol-gnome.png.2.png"><br>GNOME Terminal: no circumflex at all.</div>
	  </div>
	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/firstcol-osx.png.2.png"><br>OS X Terminal.app gets it right.</div>
	    <div class="span5 well"><img src="terminal-shots/firstcol-mosh.png.2.png"><br>Mosh gets it right too.</div>
	  </div>

	<h4 class="callout">ISO 2022 locking escapes</h4>

	<p>Only Mosh will never get stuck in hieroglyphs when a nasty program writes to the terminal. (See Markus Kuhn's discussion of the relationship between
<a href="http://www.cl.cam.ac.uk/~mgk25/unicode.html#term">ISO 2022 and UTF-8</a>.)</p>

	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/acs-xterm.png.2.png"><br>xterm</div>
	    <div class="span5 well"><img src="terminal-shots/acs-gnome.png.2.png"><br>GNOME Terminal</div>
	  </div>
	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/acs-osx.png.2.png"><br>OS X Terminal.app</div>
	    <div class="span5 well"><img src="terminal-shots/acs-mosh.png.2.png"><br>Mosh</div>
	  </div>

	<h4 class="callout">Evil escape sequences</h4>

<p>Only Mosh and GNOME Terminal have a defensible rendering when
Unicode mixes with an ECMA-48/ANSI escape sequence. The OS X Terminal
unwisely tries to normalize its input before the vt500 state machine,
causing it to misinterpret and become unusable after receiving the
following input!* (This also means the OS X Terminal's interpretation
of the incoming octet stream <strong>varies</strong> depending on how
the incoming octets are split across TCP segments, because the
normalization only looks ahead to available bytes.)</p>

<p><small>* We earlier wrote that this misbehaving sequence "crashes"
the OS X Terminal.app. This was mistaken&mdash;instead, Terminal.app
interprets the escape sequence as shutting off keyboard input, and
because of an unrelated bug in Terminal.app, it is not possible for
the user to restore keyboard input by resetting the terminal from the
menu.</small></p>

	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/unicode-and-escape-xterm.png.2.png"><br>xterm: circumflex on wrong letter.</div>
	    <div class="span5 well"><img src="terminal-shots/unicode-and-escape-gnome.png.2.png"><br>GNOME Terminal's circumflex placement is defensible.</div>
	  </div>
	  <div class="row">
	    <div class="span5 well"><img src="terminal-shots/unicode-and-escape-osx.png.2.png"><br>OS X Terminal.app applies circumflex to part of escape sequence, then irretrievably shuts off keyboard input.</div>
	    <div class="span5 well"><img src="terminal-shots/unicode-and-escape-mosh.png.2.png"><br>Mosh gets this one right.</div>
	  </div>

	  <h4 class="callout">Mosh sets IUTF8</h4>

	  <p>In the POSIX framework, the kernel needs to know whether
	  the user is typing in an 8-bit character set or in UTF-8,
	  because in canonical mode (i.e. "cooked" mode), the kernel
	  needs to be able to delete a typed multibyte character
	  sequence from an input buffer.  On OS X and Linux, this is
	  done with the "IUTF8" termios flag.)
	  (See <a href="http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=665757">diagnostic
	      explaining the need for this flag.</a>)</p>

	  <p>Mosh sets the IUTF8 flag when possible and stubbornly refuses to start up unless the user has a
	  UTF-8-clean environment. SSH does not set the IUTF8 flag, which can lead to garbage in input buffers.</p>

	<h3 class="callout">Instant local echo and line editing</h3>

	  <p>The other major benefit of working at the
	    terminal-emulation layer is that the Mosh client is free
	    to scribble on the local screen without lasting
	    consequence. We use this to implement intelligent local
	    echo. The client runs a predictive model in the background
	    of the server's behavior, hypothesizing that each
	    keystroke will be echoed at the cursor location and that
	    the backspace and left- and right-arrow keys will have
	    their traditional effect. But only when a prediction is
	    confirmed by the server are these effects actually shown
	    to the user. (In addition, by default predictions are only
	    displayed on high-delay connections or during a network
	    “glitch.”) Predictions are done in epochs: when the
	    user does something that might alter the echo behavior
	    &mdash; like hit ESC or carriage return or an up- or
	    down-arrow &mdash; Mosh goes back into making background
	    predictions until a prediction from the new batch can be
	    confirmed as correct.</p>

	  <p>Thus, unlike previous attempts at local echo with TELNET
	    and RLOGIN, Mosh's local echo can be used everywhere, even
	    in full-screen programs like emacs and vi.</p>

	<h4 class="callout">Real-world benefits</h3>

<p>We evaluated Mosh using traces contributed by six users, covering
about 40 hours of real-world usage and including 9,986 total
keystrokes. These traces included the timing and contents of all
writes from the user to the host and vice versa. The users were asked
to contribute "typical, real-world sessions." In practice, the traces
include use of popular programs such as the bash shell and zsh shells,
the alpine and mutt e-mail clients, the emacs and vim text editors,
the irssi and barnowl chat clients, the links text-mode Web browser,
and several programs unique to each user.</p>

<p>To evaluate typical usage of a "mobile'' terminal, we replayed the
traces over an otherwise unloaded Sprint commercial EV-DO (3G)
cellular Internet connection in Cambridge, Mass. A client-side process
played the user portion of the traces, and a server-side process
waited for the expected user input and then replied (in time) with the
prerecorded server output. We speeded up long periods with no
activity.  The average round-trip time on the link was about half a
second.</p>

<p>We replayed the traces over two different transports, SSH and Mosh,
and recorded the user interface response latency to each simulated
user keystroke. The Mosh predictive algorithm was frozen prior to
collecting the traces and was not adjusted in response to their
contents or results.</p>

<p><strong>The results:</strong> Mosh reduced the median keystroke response
time from 503 ms to nearly instant (because more than 70% of the
keystrokes could be immediately displayed), and reduced the mean
keystroke response time from 515 ms to 173 ms. Qualitatively, Mosh makes
remote servers "feel" more like the local machine!</p>

<div class="well">
<h4 class="callout">Cumulative distribution of keystroke response times with Sprint EV-DO (3G) Internet service</h4><br>
<img src="cdfs.png">
</div>

      </section>

      <section id="faq">
	<div class="page-header">
	  <h1>Frequently Asked Questions</h1>
	</div>

	<h4 class="callout">Q: Who wrote Mosh?</h4>

	<p>Mosh was written by Keith Winstein, along with Anders Kaseorg, Quentin Smith, Richard Tibbetts and Keegan McAllister.</p>

	<h4 class="callout">Q: Why another remote-terminal protocol?</h4>

	<p>Practical latency on the Internet is on the increase, with
	  the rise of bufferbloat and sophisticated wireless links
	  that optimize for throughput over delay. And roaming is more
	  common than ever, now that laptops and handheld devices have
	  largely displaced desktops. SSH is great, but frustrating to
	  use when you want to change IP addresses or have a
	  long-delay link or a dodgy connection.</p>

	<p>Moreover, TELNET had some good things going for it &mdash; a
	  local-echo mode and a well-defined network virtual
	  terminal. Even today, SSH doesn't properly support UTF-8
	  end-to-end on a POSIX system.</p>

	<h4 class="callout">Q: Are the mosh principles relevant to other network applications?</h4>

	<p>We think so. The design principles that Mosh stands for are
	  conservative: warning the user if the state being displayed
	  is out of date, serializing and checkpointing all
	  transactions so that if there are no warnings, the user
	  knows every prior transaction has succeeded, and handling expected events (like roaming from one
	  WiFi network to another) gracefully.</p>

	<p>Those don't seem too controversial, but fancy apps like
	Gmail-in-Chromium or on Android still behave atrociously on
	dodgy connections or after switching IP addresses. (Have you
	ever had Gmail leave an e-mail message in "Sending..." for ten
	hours while merrily retrieving new mail and not indicating any
	kind of error? Us too.) We think there may be considerable
	room for improvement in many network user interfaces from the
	application of these values.</p>

	<h4 class="callout">Q: I'm getting "mosh requires a UTF-8 locale."
        How can I fix this?</h4>

        <p>To diagnose the problem, run <code>locale</code> on the local
        terminal, and <code>ssh <i>remotehost</i> locale</code>. To use Mosh,
        both sides of the connection will need to show a UTF-8 locale, like
        <code>LC_CTYPE="en_US.UTF-8"</code>.

        <p>On many systems, SSH will transfer the locale-related
        environment variables, which are then inherited by
        <code>mosh-server</code>.  If this mechanism fails, Mosh (as of
        version 1.2) will pass the variables itself.  If neither
        mechanism is successful, you can do something like

        <pre>mosh <i>remotehost</i> <b>--server="LANG=en_US.UTF-8 mosh-server"</b></pre>

        If <code>en_US.UTF-8</code> does not exist on the remote server,
        you can replace this with a UTF-8 locale that does exist.  You
        may also need to set LANG locally for the benefit of
        <code>mosh-client</code>.  It is possible that the local and
        remote machines will need different locale names. See also <a
        href="https://github.com/keithw/mosh/issues/98">this GitHub
        ticket</a>.</p>

        <h4 class="callout">Q: Why do you insist on UTF-8 everywhere?</h4>

	<p>We're really not UTF-8 zealots. But it's a lot easier to
	correctly implement <strong>one</strong> terminal emulator
	than to try to do the right thing in a variety of difficult
	edge cases. (This is what GNU screen tries to do, and in our
	experience it leads to some very tricky-to-debug situations.)
	So mosh just won't start up until the user has everything
	configured for a UTF-8-clean pathway. It may be annoying, but
	it also probably reduces frustration down the
	road. (Unfortunately an 8-bit vt220 and a UTF-8 vt220 are
	different and incompatible terminal types; the UTF-8 goes
	in <strong>underneath</strong> the vt220 state machine.)</p>

	<h4 class="callout">Q: How do I use a different SSH port (not 22)?</h4>

        <p>As of Mosh 1.2, you can pass arguments to <code>ssh</code> like so:

        <pre>mosh <i>remotehost</i> <b>--ssh="ssh -p 2222"</b></pre>

        Or configure a host alias in <code>~/.ssh/config</code> with a
        <code>Port</code> directive.  Mosh will respect that too.</p>

	<h4 class="callout">Q: I'm getting 'mosh-server not found'.</h4>

	<p>Please make sure that mosh is installed on the client, and
	mosh (or at least mosh-server) is installed on the server you
	are trying to connect to. If you install mosh-server in your
	home directory, please see the "Server binary outside path"
	instructions in the Usage section, above.</p>

        <h4 class="callout">Q: SSH authenticates using Kerberos tickets, but Mosh asks me for a password.</h4>
        <p>In some configurations, SSH canonicalizes the hostname
        before passing it to the Kerberos GSSAPI plugin.  This breaks
        for Mosh, because the initial forward DNS lookup is done by
        the Mosh wrapper script.  To work around this, invoke Mosh as

        <pre>mosh <i>remotehost</i> <b>--ssh="ssh -o GSSAPITrustDns=no"</b></pre>

        This <a href="https://bugzilla.mindrot.org/show_bug.cgi?id=1008">will
        often fail</a> on a round-robin DNS setup.  In that case it is probably
        best to pick a specific host from the round-robin pool.</p>

	<h4 class="callout">Q: Why is my terminal's scrollback buffer incomplete?</h4>

        <p>Mosh 1.2 synchronizes only the visible state of the terminal.  Mosh
        1.3 will have complete scrollback support; see <a
        href="https://github.com/keithw/mosh/issues/2">this issue</a> and the
        others which are linked from there.  For now, the workaround is to use
        <a href="http://www.gnu.org/software/screen/">screen</a> or <a
        href="http://tmux.sourceforge.net/">tmux</a> on the remote side.</p>

	<h4 class="callout">Q: How do I get 256 colors?</h4>

	<p>Make sure you are running mosh in a terminal that
	advertises itself as 256-color capable. (This generally means
	TERM will be xterm-256color or screen-256color-bce.)</p>

	<h4 class="callout">Q: Has your secure datagram protocol been audited by experts?</h4>

	<p>No. Mosh is actively used and has been read over by
	  security-minded crypto nerds who think its design is
	  reasonable, but any novel datagram protocol is going to have
	  to prove itself, and SSP is no exception. We use the
	  reference implementations of AES-128 and OCB, and we welcome
	  your eyes on the code. We think the radical simplicity of
	  the design is an advantage, but of course others have
	  thought that and have been wrong. We don't doubt it will
	  (properly!) take time for the security community to get
	  comfortable with mosh.</p>

	<h4 class="callout">Q: Does mosh work with Amazon EC2?</h4>

	<p>Yes, it works great, but please remember to open up UDP ports 60000&ndash;61000 on the EC2 firewall.</p>

	<h4 class="callout">Q: How do I run the mosh client and server separately?</h4>

	<p>If the <code>mosh</code> wrapper script isn't working for you, you can try running
	  the <code>mosh-client</code> and <code>mosh-server</code> programs separately to
	  form a connection. This can be a useful debugging technique.</p>

	<p>1. Log in to the remote host, and run <code>mosh-server</code>.</p>

	<p>It will give output like:
<pre>$ mosh-server 

MOSH CONNECT <b>60004</b> <b>4NeCCgvZFe2RnPgrcU1PQw</b>

mosh-server (mosh 1.1.3)
Copyright 2012 Keith Winstein &lt;mosh-devel@mit.edu&gt;
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

[mosh-server detached, pid = 30261]
</pre></p>

	<p>2. On the local host, run:
<pre>$ MOSH_KEY=<b>key</b> mosh-client <b>remote-IP</b> <b>remote-PORT</b></pre>

where "key" is the 22-byte string printed by mosh-server (in this
example, "4NeCCgvZFe2RnPgrcU1PQw"), "remote-PORT" is the port number
given by the server (60004 in this case), and "remote-IP" is the IP address of the server. You can look up the
server's IP address with "host remotehost".</p>

	<p>3. If all goes well, you should have a working Mosh connection. Information about where the process fails can help us debug why Mosh isn't working for you.</p>

	<h4 class="callout">Q: With the mosh-server on FreeBSD or OS X, I sometimes get weird color problems. What's wrong?</h4>

	<p>This <a href="https://github.com/keithw/mosh/pull/129">bug</a> is fixed in Mosh 1.2. Thanks to Ed Schouten and Peter Jeremy for tracking this down.</p>

	<h4 class="callout">Q: How do I contribute to mosh?</h4>

	<p>We welcome your contribution! Please <a href="https://github.com/keithw/mosh">visit us on GitHub</a>
	or email <code>mosh-devel@mit.edu</code>.</p>

	<h4 class="callout">Q: Who helped with mosh?</h4>

	<p>We're very grateful for assistance and support from:

	  <ul>

<li>Hari Balakrishnan, who advised this work and came up with the name.

<li><a href="http://www.vt100.net">Paul Williams</a>, whose reverse-engineered vt500 state diagram is the basis for the Mosh parser.

<li>The anonymous users who contributed session logs for tuning and measuring Mosh's predictive echo.

<li>Nickolai Zeldovich for helpful comments on the Mosh research paper.

<li>Richard Stallman for helpful discussion about the capabilities of the <a href="http://hdl.handle.net/1721.1/5694">SUPDUP Local Editing Protocol</a>.

<li>Nelson Elhage

<li>Christine Spang

<li>Stefie Tellex

<li>Joseph Sokol-Margolis

<li>Waseem Daher

<li>Bill McCloskey

<li>Austin Roach

<li>Greg Hudson

<li>Karl Ramm

<li>Alexander Chernyakhovsky

<li>Peter Iannucci

<li>Evan Broder

<li>Neha Narula

<li>Katrina LaCurts

<li>Ramesh Chandra

</ul>

      </section>

      <section id="contact">
	<div class="page-header">
	  <h1>Contact</h1>
	</div>
	
	<p><ul>
	    <li><p><code>mosh-devel@mit.edu</code><br>
	      Mosh development and discussion.

	      Sign up or view archives at <a href="http://mailman.mit.edu/mailman/listinfo/mosh-devel">http://mailman.mit.edu/mailman/listinfo/mosh-devel</a>.</p></li>

	    <li><p><code>mosh-users@mit.edu</code><br>
	      Mosh user discussion and site best practices.

	      Sign up or view archives at <a href="http://mailman.mit.edu/mailman/listinfo/mosh-users">http://mailman.mit.edu/mailman/listinfo/mosh-users</a>.</p></li>

	    <li><p><code>#mosh</code> channel on <a href="http://freenode.net/">Freenode</a> IRC<br>

              You can <a
              href="http://webchat.freenode.net/?channels=mosh">connect with a
              Web client</a>, try an <a
              href="irc://irc.freenode.net/mosh"><tt>irc://</tt> URL</a>,
              or manually configure your client for <code>irc.freenode.net</code>.</p></li>

	    <li><p>At the recommendation of the security community, <b>confidential security-related matters</b> may be sent to: <code>mosh-security@mit.edu</code><br>

	      <div class="callout">
		Messages may optionally be encrypted with <a href="keithw-gpg.txt">Keith Winstein's public key</a>:

<pre>pub   4096R/FE254C69 2012-02-05 [expires: 2015-02-04]
      Key fingerprint = B1A4 7069 121F 6642 BB3D  7F3E 20B7 283A FE25 4C69</pre>
	      </div></p></li>

	    </ul></p>


      </section>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="assets/js/jquery.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
  </body>
</html>
